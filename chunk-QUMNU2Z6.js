import{a as $}from"./chunk-KODUIQMG.js";import{d as F,s as O,v as Q}from"./chunk-45QSGMLT.js";var E=class L{constructor(e){this.dbService=e}generateTournamentID(){let e=Date.now().toString(36),n=Math.random().toString(36).substring(2,8);return`T-${e}-${n}`}generateMatchID(e,n,t){return`${t==="winners"?"W":t==="losers"?"L":"F"}R${e}M${n+1}`}nextPowerOf2(e){return Math.pow(2,Math.ceil(Math.log2(e)))}shuffleArray(e){let n=[...e];for(let t=n.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[n[t],n[o]]=[n[o],n[t]]}return n}generateSeedPairings(e){let n=r=>{if(r===2)return[1,2];let c=r/2,s=n(c),m=[];for(let a of s)m.push(a),m.push(r+1-a);return m},t=n(e),o=[];for(let r=0;r<t.length;r+=2)o.push([t[r],t[r+1]]);return o}getRoundName(e,n,t,o){if(o==="finals")return n===1?"Finals":"Grand Finals";let r=o==="losers"?"Losers ":"";return e===1?r+"Finals":e===2?r+"Semifinals":e===4?r+"Quarterfinals":r+`Round ${n}`}createTournament(e){return F(this,null,function*(){let n=this.generateTournamentID(),t=new Date().toISOString(),o=e.teamNames;e.seedingMethod==="random"&&(o=this.shuffleArray(e.teamNames));let r=e.type==="single-elimination"?this.generateSingleEliminationRounds(o,e.questionSetsByRound):this.generateDoubleEliminationRounds(o,e.questionSetsByRound),c={tournamentID:n,name:e.name,type:e.type,status:"in-progress",teamNames:o,datasetId:e.datasetId,rounds:r,createdAt:t,updatedAt:t};return yield this.dbService.addTournament(c),c})}generateSingleEliminationRounds(e,n){let t=e.length,r=this.nextPowerOf2(t)/2,c=(t-r)*2,s=t-c,m=c/2;if(m===0||t<=2)return this.generateSimpleBracket(e,n);let a=[],h=Math.ceil(Math.log2(t)),u=[],d=s+1;for(let l=0;l<m;l++){let T=d+l,S=t-l,g=e[T-1],N=e[S-1],D=this.generateMatchID(1,l,"winners"),k=Math.floor((r-1-l)/2),x=(r-1-l)%2===0?"team1":"team2",i={matchID:D,position:l,quizNumber:0,team1Slot:{type:"team",teamName:g},team2Slot:{type:"team",teamName:N},result:null,winnerAdvancesTo:{bracketType:"winners",roundNumber:2,matchPosition:k,slot:x},loserAdvancesTo:null};u.push(i)}u.length>0&&a.push({roundNumber:1,bracketType:"winners",name:m===1?"Play-in":"Round 1",questionSetId:n.get(1)||"",matches:u});let M=[],p=r/2;for(let l=0;l<p;l++){let T=this.generateMatchID(2,l,"winners"),S=this.generateSeedPairings(r),[g,N]=S[l],D,k;if(g<=s)D={type:"team",teamName:e[g-1]};else{let f=g-s-1;D={type:"winner-of",sourceMatchId:this.generateMatchID(1,f,"winners")}}if(N<=s)k={type:"team",teamName:e[N-1]};else{let f=N-s-1;k={type:"winner-of",sourceMatchId:this.generateMatchID(1,f,"winners")}}let x=Math.floor(l/2),i=l%2===0?"team1":"team2",y={matchID:T,position:l,quizNumber:0,team1Slot:D,team2Slot:k,result:null,winnerAdvancesTo:p>1?{bracketType:"winners",roundNumber:3,matchPosition:x,slot:i}:null,loserAdvancesTo:null};M.push(y)}a.push({roundNumber:2,bracketType:"winners",name:this.getRoundName(p,2,h,"winners"),questionSetId:n.get(2)||"",matches:M});let I=p;for(let l=3;l<=h;l++){let T=I/2,S=[];for(let g=0;g<T;g++){let N=this.generateMatchID(l,g,"winners"),D=a[a.length-1],k=D.matches[g*2],x=D.matches[g*2+1],i={type:"winner-of",sourceMatchId:k.matchID},y={type:"winner-of",sourceMatchId:x.matchID},f=Math.floor(g/2),P=g%2===0?"team1":"team2",R={matchID:N,position:g,quizNumber:0,team1Slot:i,team2Slot:y,result:null,winnerAdvancesTo:l<h?{bracketType:"winners",roundNumber:l+1,matchPosition:f,slot:P}:null,loserAdvancesTo:null};S.push(R)}a.push({roundNumber:l,bracketType:"winners",name:this.getRoundName(T,l,h,"winners"),questionSetId:n.get(l)||"",matches:S}),I=T}return this.assignQuizNumbers(a),a}generateSimpleBracket(e,n){let t=e.length,o=Math.log2(t),r=[],c=this.generateSeedPairings(t),s=[];for(let a=0;a<c.length;a++){let[h,u]=c[a],d=this.generateMatchID(1,a,"winners"),M=Math.floor(a/2),p=a%2===0?"team1":"team2",I={matchID:d,position:a,quizNumber:0,team1Slot:{type:"team",teamName:e[h-1]},team2Slot:{type:"team",teamName:e[u-1]},result:null,winnerAdvancesTo:o>1?{bracketType:"winners",roundNumber:2,matchPosition:M,slot:p}:null,loserAdvancesTo:null};s.push(I)}r.push({roundNumber:1,bracketType:"winners",name:this.getRoundName(s.length,1,o,"winners"),questionSetId:n.get(1)||"",matches:s});let m=s.length;for(let a=2;a<=o;a++){let h=m/2,u=[];for(let d=0;d<h;d++){let M=this.generateMatchID(a,d,"winners"),p=r[a-2],I=p.matches[d*2],l=p.matches[d*2+1],T={type:"winner-of",sourceMatchId:I.matchID},S={type:"winner-of",sourceMatchId:l.matchID},g=Math.floor(d/2),N=d%2===0?"team1":"team2",D={matchID:M,position:d,quizNumber:0,team1Slot:T,team2Slot:S,result:null,winnerAdvancesTo:a<o?{bracketType:"winners",roundNumber:a+1,matchPosition:g,slot:N}:null,loserAdvancesTo:null};u.push(D)}r.push({roundNumber:a,bracketType:"winners",name:this.getRoundName(h,a,o,"winners"),questionSetId:n.get(a)||"",matches:u}),m=h}return this.propagateByeResults(r),this.assignQuizNumbers(r),r}generateDoubleEliminationRounds(e,n){let t=e.length;if(t<2)return[];let o=Math.floor(t/2),r=t%2===1,c=Math.ceil(t/2),s=Math.ceil(Math.log2(t)),m=[],a=1,h=[];if(r){let y={matchID:this.generateMatchID(1,0,"winners"),position:0,quizNumber:0,team1Slot:{type:"team",teamName:e[0]},team2Slot:{type:"bye"},result:null,winnerAdvancesTo:{bracketType:"winners",roundNumber:2,matchPosition:0,slot:"team1"},loserAdvancesTo:null};h.push(y);for(let f=0;f<o;f++){let P=f+2,R=t-f,b=this.generateMatchID(1,f+1,"winners"),A=Math.floor((f+1)/2),C=(f+1)%2===0?"team1":"team2",w={matchID:b,position:f+1,quizNumber:0,team1Slot:{type:"team",teamName:e[P-1]},team2Slot:{type:"team",teamName:e[R-1]},result:null,winnerAdvancesTo:{bracketType:"winners",roundNumber:2,matchPosition:A,slot:C},loserAdvancesTo:{bracketType:"losers",roundNumber:1,matchPosition:f,slot:"team1"}};h.push(w)}}else for(let i=0;i<o;i++){let y=i+1,f=t-i,P=this.generateMatchID(1,i,"winners"),R=Math.floor(i/2),b=i%2===0?"team1":"team2",A={matchID:P,position:i,quizNumber:0,team1Slot:{type:"team",teamName:e[y-1]},team2Slot:{type:"team",teamName:e[f-1]},result:null,winnerAdvancesTo:o===1?{bracketType:"finals",roundNumber:1,matchPosition:0,slot:"team1"}:{bracketType:"winners",roundNumber:2,matchPosition:R,slot:b},loserAdvancesTo:{bracketType:"losers",roundNumber:1,matchPosition:i,slot:"team1"}};h.push(A)}let u;o===1&&!r?u="Winners Final":o<=2?u="Winners Semifinals":o<=4?u="Winners Quarterfinals":u="Winners Round 1",m.push({roundNumber:1,bracketType:"winners",name:u,questionSetId:n.get(a++)||"",matches:h});let d=Math.ceil(h.length/2);r&&(d=Math.ceil((o+1)/2));for(let i=2;i<=s&&!(d<1);i++){let y=[],f=m.find(b=>b.bracketType==="winners"&&b.roundNumber===i-1),P=d===1;for(let b=0;b<d;b++){let A=this.generateMatchID(i,b,"winners"),C=b*2,w=b*2+1,v,z;C<f.matches.length?v={type:"winner-of",sourceMatchId:f.matches[C].matchID}:v={type:"bye"},w<f.matches.length?z={type:"winner-of",sourceMatchId:f.matches[w].matchID}:z={type:"bye"};let W=(i-1)*2,B={matchID:A,position:b,quizNumber:0,team1Slot:v,team2Slot:z,result:null,winnerAdvancesTo:P?{bracketType:"finals",roundNumber:1,matchPosition:0,slot:"team1"}:{bracketType:"winners",roundNumber:i+1,matchPosition:Math.floor(b/2),slot:b%2===0?"team1":"team2"},loserAdvancesTo:{bracketType:"losers",roundNumber:W,matchPosition:b,slot:"team2"}};y.push(B)}let R;d===1?R="Winners Final":d===2?R="Winners Semifinals":d===4?R="Winners Quarterfinals":R=`Winners Round ${i}`,m.push({roundNumber:i,bracketType:"winners",name:R,questionSetId:n.get(a++)||"",matches:y}),d=Math.ceil(d/2)}let M=m.filter(i=>i.bracketType==="winners"),p=M.length,I=new Map;for(let i of M){let y=i.matches.filter(f=>f.team1Slot.type!=="bye"&&f.team2Slot.type!=="bye");I.set(i.roundNumber,y)}let l=[],T=1,S=1,g=I.get(1)||[];for(let i of g)l.push({type:"loser-of",matchId:i.matchID});for(;l.length>1||S<p;){let i=[],y=T%2===0,f=y?T/2+1:0,P=y&&f<=p,R=[];if(P){let b=I.get(f)||[];for(let A of b)R.push({type:"loser-of",matchId:A.matchID});f>S&&(S=f)}if(!y||R.length===0){let b=l.length;if(b===0){T++;continue}if(b===1){if(S>=p)break;T++;continue}let A=Math.floor(b/2),C=b%2===1;for(let v=0;v<A;v++){let z=this.generateMatchID(T,v,"losers"),W=l[v*2],B=l[v*2+1],q={matchID:z,position:v,quizNumber:0,team1Slot:{type:W.type,sourceMatchId:W.matchId},team2Slot:{type:B.type,sourceMatchId:B.matchId},result:null,winnerAdvancesTo:{bracketType:"losers",roundNumber:T+1,matchPosition:v,slot:"team1"},loserAdvancesTo:null};i.push(q)}let w=[];for(let v of i)w.push({type:"winner-of",matchId:v.matchID});if(C){let v=l[A*2];w.push(v)}l=w}else{let b=l.length,A=R.length,C=Math.max(b,A);for(let w=0;w<C;w++){let v=this.generateMatchID(T,w,"losers"),z,W;if(w<b){let q=l[w];z={type:q.type,sourceMatchId:q.matchId}}else z={type:"bye"};if(w<A){let q=R[w];W={type:q.type,sourceMatchId:q.matchId}}else W={type:"bye"};let B={matchID:v,position:w,quizNumber:0,team1Slot:z,team2Slot:W,result:null,winnerAdvancesTo:{bracketType:"losers",roundNumber:T+1,matchPosition:w,slot:"team1"},loserAdvancesTo:null};i.push(B)}l=i.map(w=>({type:"winner-of",matchId:w.matchID}))}if(i.length>0&&m.push({roundNumber:T,bracketType:"losers",name:`L Round ${T}`,questionSetId:n.get(a++)||"",matches:i}),T++,T>20){console.error("Losers bracket generation exceeded 20 rounds - breaking");break}}let N=m.filter(i=>i.bracketType==="losers"),D=new Set(N.map(i=>i.roundNumber));for(let i of N)for(let y of i.matches)if(y.winnerAdvancesTo&&y.winnerAdvancesTo.bracketType==="losers"){let f=y.winnerAdvancesTo.roundNumber;for(;f<=20&&!D.has(f);)f++;D.has(f)&&(y.winnerAdvancesTo.roundNumber=f)}if(N.length>0){let i=N[N.length-1];i.name="L Final";for(let y of i.matches)y.winnerAdvancesTo={bracketType:"finals",roundNumber:1,matchPosition:0,slot:"team2"}}let k=m.filter(i=>i.bracketType==="winners").sort((i,y)=>y.roundNumber-i.roundNumber)[0],x=m.filter(i=>i.bracketType==="losers").sort((i,y)=>y.roundNumber-i.roundNumber)[0];if(k&&x){let i={matchID:this.generateMatchID(1,0,"finals"),position:0,quizNumber:0,team1Slot:{type:"winner-of",sourceMatchId:k.matches[0].matchID},team2Slot:{type:"winner-of",sourceMatchId:x.matches[0].matchID},result:null,winnerAdvancesTo:null,loserAdvancesTo:null};m.push({roundNumber:1,bracketType:"finals",name:"Championship",questionSetId:n.get(a++)||"",matches:[i]})}return this.propagateByeResults(m),this.assignQuizNumbers(m),m}propagateByeResults(e){let n=new Map;for(let c of e)for(let s of c.matches)n.set(s.matchID,s);let t=!0,o=0,r=100;for(;t&&o<r;){t=!1,o++;for(let c of e)for(let s of c.matches){if(s.result&&s.result.winnerTeamName&&s.winnerAdvancesTo){let m=e.find(a=>a.bracketType===s.winnerAdvancesTo.bracketType&&a.roundNumber===s.winnerAdvancesTo.roundNumber);if(m){let a=m.matches[s.winnerAdvancesTo.matchPosition];if(a){let h=s.winnerAdvancesTo.slot==="team1"?a.team1Slot:a.team2Slot;(h.type==="winner-of"||h.type==="loser-of")&&(h.type="team",h.teamName=s.result.winnerTeamName,h.sourceMatchId=void 0,t=!0)}}}if(!s.result){let m=u=>{if(u.type==="loser-of"&&u.sourceMatchId){let d=n.get(u.sourceMatchId);if(d?.result&&d.result.loserTeamName==="")return u.type="bye",u.sourceMatchId=void 0,!0}return!1},a=m(s.team1Slot),h=m(s.team2Slot);if((a||h)&&(t=!0),s.team1Slot.type==="bye"&&s.team2Slot.type!=="bye"){let u=this.resolveTeamSlotFromRounds(s.team2Slot,e,n);u&&(s.result={team1Score:0,team2Score:0,winnerTeamName:u,loserTeamName:"",playedLocally:!1,completedAt:new Date().toISOString()},t=!0)}else if(s.team2Slot.type==="bye"&&s.team1Slot.type!=="bye"){let u=this.resolveTeamSlotFromRounds(s.team1Slot,e,n);u&&(s.result={team1Score:0,team2Score:0,winnerTeamName:u,loserTeamName:"",playedLocally:!1,completedAt:new Date().toISOString()},t=!0)}else s.team1Slot.type==="bye"&&s.team2Slot.type==="bye"&&(s.result={team1Score:0,team2Score:0,winnerTeamName:"",loserTeamName:"",playedLocally:!1,completedAt:new Date().toISOString()},t=!0)}}}}resolveTeamSlotFromRounds(e,n,t,o=new Set){if(e.type==="team")return e.teamName||null;if(e.type==="bye")return null;if((e.type==="winner-of"||e.type==="loser-of")&&e.sourceMatchId){if(o.has(e.sourceMatchId))return null;o.add(e.sourceMatchId);let r=t.get(e.sourceMatchId);if(!r)return null;if(r.result)return e.type==="winner-of"?r.result.winnerTeamName:r.result.loserTeamName;let c=r.team1Slot.type==="bye",s=r.team2Slot.type==="bye";return c&&!s&&e.type==="winner-of"?this.resolveTeamSlotFromRounds(r.team2Slot,n,t,o):s&&!c&&e.type==="winner-of"?this.resolveTeamSlotFromRounds(r.team1Slot,n,t,o):null}return null}resolveTeamSlot(e,n,t=new Set){if(e.type==="team")return e.teamName||null;if(e.type==="bye")return null;if(e.type==="winner-of"||e.type==="loser-of"){if(e.sourceMatchId&&t.has(e.sourceMatchId))return null;e.sourceMatchId&&t.add(e.sourceMatchId);let o=this.findMatch(n,e.sourceMatchId);if(!o)return null;if(o.result)return e.type==="winner-of"?o.result.winnerTeamName:o.result.loserTeamName;let r=o.team1Slot.type==="bye",c=o.team2Slot.type==="bye";return r&&!c&&e.type==="winner-of"?this.resolveTeamSlot(o.team2Slot,n,t):c&&!r&&e.type==="winner-of"?this.resolveTeamSlot(o.team1Slot,n,t):null}return null}findMatch(e,n){for(let t of e.rounds){let o=t.matches.find(r=>r.matchID===n);if(o)return o}return null}findRoundForMatch(e,n){for(let t of e.rounds)if(t.matches.some(o=>o.matchID===n))return t;return null}recordMatchResult(e,n,t,o,r){return F(this,null,function*(){let c=yield this.dbService.getTournament(e);if(!c)throw new Error("Tournament not found");let s=this.findMatch(c,n);if(!s)throw new Error("Match not found");let m=this.resolveTeamSlot(s.team1Slot,c),a=this.resolveTeamSlot(s.team2Slot,c);if(!m||!a)throw new Error("Cannot record result: teams not yet determined");if(t===o)throw new Error("Ties are not allowed in elimination matches");let h=t>o?m:a,u=t>o?a:m;s.result={team1Score:t,team2Score:o,winnerTeamName:h,loserTeamName:u,playedLocally:r,completedAt:new Date().toISOString()};let d={quizID:c.name,matchID:n,team1:m,team2:a,score1:t,score2:o};return yield this.dbService.saveMatchSummary(d),s.winnerAdvancesTo&&this.advanceTeam(c,s.winnerAdvancesTo,h),s.loserAdvancesTo&&this.advanceTeam(c,s.loserAdvancesTo,u),this.resolveByeMatchesCascade(c),c.status=this.checkTournamentComplete(c)?"completed":"in-progress",c.updatedAt=new Date().toISOString(),yield this.dbService.updateTournament(c),c})}resolveByeMatchesCascade(e){let n=!0,t=0,o=50;for(;n&&t<o;){n=!1,t++;for(let r of e.rounds)for(let c of r.matches){if(c.result)continue;let s=c.team1Slot.type==="bye",m=c.team2Slot.type==="bye";if(s&&!m){let a=this.resolveTeamSlot(c.team2Slot,e);a&&(c.result={team1Score:0,team2Score:0,winnerTeamName:a,loserTeamName:"",playedLocally:!1,completedAt:new Date().toISOString()},c.winnerAdvancesTo&&this.advanceTeam(e,c.winnerAdvancesTo,a),n=!0)}else if(m&&!s){let a=this.resolveTeamSlot(c.team1Slot,e);a&&(c.result={team1Score:0,team2Score:0,winnerTeamName:a,loserTeamName:"",playedLocally:!1,completedAt:new Date().toISOString()},c.winnerAdvancesTo&&this.advanceTeam(e,c.winnerAdvancesTo,a),n=!0)}else s&&m&&(c.result={team1Score:0,team2Score:0,winnerTeamName:"",loserTeamName:"",playedLocally:!1,completedAt:new Date().toISOString()},n=!0)}}}repairTournament(e){return F(this,null,function*(){let n=yield this.dbService.getTournament(e);if(!n)return null;let t=JSON.stringify(n.rounds);this.resolveByeMatchesCascade(n);let o=JSON.stringify(n.rounds);return t!==o&&(n.updatedAt=new Date().toISOString(),yield this.dbService.updateTournament(n)),n})}advanceTeam(e,n,t){for(let o of e.rounds)if(o.bracketType===n.bracketType&&o.roundNumber===n.roundNumber){let r=o.matches[n.matchPosition];if(r){let c=n.slot==="team1"?r.team1Slot:r.team2Slot;c.type="team",c.teamName=t,c.sourceMatchId=void 0}break}}checkTournamentComplete(e){for(let n of e.rounds)for(let t of n.matches)if(!(t.team1Slot.type==="bye"||t.team2Slot.type==="bye")&&!t.result)return!1;return!0}getTournamentWinner(e){if(e.status!=="completed")return null;let n=e.rounds.find(o=>o.bracketType==="finals");if(n&&n.matches.length>0)return n.matches[n.matches.length-1].result?.winnerTeamName||null;let t=e.rounds.filter(o=>o.bracketType==="winners");if(t.length>0){let o=t[t.length-1];if(o.matches.length===1&&o.matches[0].result)return o.matches[0].result.winnerTeamName}return null}getPlayableMatches(e){let n=[];for(let t of e.rounds)for(let o of t.matches){if(o.result||o.team1Slot.type==="bye"||o.team2Slot.type==="bye")continue;let r=this.resolveTeamSlot(o.team1Slot,e),c=this.resolveTeamSlot(o.team2Slot,e);r&&c&&n.push(o)}return n}getRoundCount(e,n){if(e<2)return 0;let t=Math.ceil(Math.log2(e));if(n==="single-elimination")return t;{let o=(t-1)*2;return t+o+1}}getRoundNames(e,n){if(e<2)return[];let t=[],o=Math.ceil(Math.log2(e)),r=Math.floor(e/2),c=e%2===1,s=c?r+1:r;for(let m=1;m<=o;m++){let a=m===1?r:s;a===1&&!c&&m===1?t.push(n==="single-elimination"?"Finals":"Winners Final"):a<=2?t.push(n==="single-elimination"?"Semifinals":"Winners Semifinals"):a<=4?t.push(n==="single-elimination"?"Quarterfinals":"Winners Quarterfinals"):t.push(n==="single-elimination"?`Round ${m}`:`Winners Round ${m}`),m===1?s=Math.ceil((c?r+1:r)/2):s=Math.ceil(s/2)}if(n==="double-elimination"){let m=(o-1)*2;for(let a=1;a<=m;a++)a===m?t.push("L Final"):t.push(`L Round ${a}`);t.push("Championship")}return t}assignQuizNumbers(e){let n=new Map,t=new Map;for(let h of e)for(let u of h.matches)n.set(u.matchID,u),t.set(u.matchID,h);let o=[];for(let h of e)for(let u of h.matches)u.team1Slot.type==="bye"||u.team2Slot.type==="bye"?u.quizNumber=0:o.push(u);let r=h=>{let u=[];for(let d of[h.team1Slot,h.team2Slot])(d.type==="winner-of"||d.type==="loser-of")&&d.sourceMatchId&&u.push(d.sourceMatchId);return u},c=h=>{let u=new Set,d=M=>{if(M.type==="team"&&M.teamName)u.add(M.teamName);else if((M.type==="winner-of"||M.type==="loser-of")&&M.sourceMatchId){let p=n.get(M.sourceMatchId);p&&(d(p.team1Slot),d(p.team2Slot))}};return d(h.team1Slot),d(h.team2Slot),u},s=[],m=new Set,a=1;for(;s.length<o.length;){let h=[];for(let p of o){if(m.has(p.matchID))continue;r(p).every(T=>{let S=n.get(T);return m.has(T)||S&&(S.team1Slot.type==="bye"||S.team2Slot.type==="bye")})&&h.push(p)}if(h.length===0){console.error("No ready matches but not all scheduled");break}let u=new Map;for(let p of s){let I=c(p);for(let l of I)u.set(l,p.quizNumber)}let d=p=>{let I=c(p),l=1/0;for(let g of I){let N=u.get(g)||0,D=a-N;l=Math.min(l,D)}let T=t.get(p.matchID),S=0;return T&&(T.bracketType==="winners"?S=0:T.bracketType==="losers"?S=1:S=2),-l*100+S};h.sort((p,I)=>d(p)-d(I));let M=h[0];M.quizNumber=a++,s.push(M),m.add(M.matchID)}}static \u0275fac=function(n){return new(n||L)(Q($))};static \u0275prov=O({token:L,factory:L.\u0275fac,providedIn:"root"})};export{E as a};
