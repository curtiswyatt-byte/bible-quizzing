import{a as N}from"./chunk-7WO65EVB.js";import{a as q}from"./chunk-KODUIQMG.js";import{Ja as I,a as b,b as D,d as c,i as S,s as h,v as g}from"./chunk-45QSGMLT.js";var y=class p{constructor(e){this.http=e}catalogPromise;getCatalog(){return this.catalogPromise||(console.log("\u{1F4DA} Loading dataset catalog..."),this.catalogPromise=S(this.http.get("datasets/catalog.json")).then(e=>(console.log(`\u{1F4DA} Loaded ${e?.length??0} datasets from catalog`),e??[])).catch(e=>(console.error("\u274C Failed to load dataset catalog:",e),this.catalogPromise=void 0,[]))),this.catalogPromise}reloadCatalog(){return this.catalogPromise=void 0,this.getCatalog()}static \u0275fac=function(s){return new(s||p)(g(I))};static \u0275prov=h({token:p,factory:p.\u0275fac,providedIn:"root"})};var w=class p{constructor(e,s,o){this.dbService=e;this.datasetCatalog=s;this.quizState=o}dataLoaded=!1;activeDatasetId=null;currentBook="";currentVersion="";datasetStorageKey="activeDatasetId";initialize(){return c(this,null,function*(){if(this.dataLoaded)return;if(yield this.dbService.init(),yield this.dbService.initializeDefaultTypes(),!(yield this.datasetCatalog.getCatalog()).length){console.warn("Dataset catalog is empty. Please add datasets to /public/datasets/catalog.json.");return}let s=this.getPersistedDatasetId();s&&(this.activeDatasetId=s,console.log(`\u{1F4DA} Active dataset: ${s} (questions not reloaded on init)`)),this.dataLoaded=!0})}getActiveDatasetId(){return this.activeDatasetId??this.getPersistedDatasetId()}loadDatasetById(o){return c(this,arguments,function*(e,s={}){let i=(yield this.datasetCatalog.getCatalog()).find(a=>a.id===e);if(!i)throw new Error(`Dataset with id "${e}" not found in catalog.`);yield this.loadDataset(i,{persistSelection:!0,resetMatch:!0,questionsOnly:s.questionsOnly===!0})})}loadDataset(o){return c(this,arguments,function*(e,s={}){try{console.log(`\u{1F504} Activating dataset: ${e.book} (${e.version})`),this.dataLoaded=!1,this.currentBook=e.book,this.currentVersion=e.version,s.resetMatch!==!1&&this.quizState.resetMatch(),s.questionsOnly?(console.log("\u{1F4CB} Loading questions only - preserving player and team data"),yield this.clearQuestionData()):yield this.dbService.clearAllData();let t=yield fetch(e.path);if(!t.ok)throw new Error(`Failed to load dataset from ${e.path}: ${t.statusText}`);let i=yield t.json();yield this.processData(i,{questionsOnly:s.questionsOnly}),yield this.dbService.initializeDefaultTypes();let a={book:e.book,quizDBname:e.databaseName??`${e.book} Dataset`,quizIDPre:e.quizIdPrefix??"Quiz",quizIDNum:e.quizIdNumber??"1",backupDrive:e.backupDrive??"A",bookVersion:e.version,datasetId:e.id};yield this.dbService.saveUserFile(a),this.activeDatasetId=e.id,s.persistSelection!==!1&&this.persistActiveDatasetId(e.id),this.dataLoaded=!0,console.log(`\u2705 Dataset ready: ${e.book} (${e.version})`)}catch(t){throw console.error("\u274C Error activating dataset:",t),this.dataLoaded=!1,t}})}loadFromDataObject(o){return c(this,arguments,function*(e,s={}){if(this.dataLoaded&&!s.forceReload){console.log("Data already loaded, skipping... (loadFromDataObject)");return}try{if(s.dataset&&(this.currentBook=s.dataset.book??"Unknown Book",this.currentVersion=s.dataset.version??""),s.resetMatch!==!1&&this.quizState.resetMatch(),yield this.dbService.init(),yield this.processData(e),yield this.dbService.initializeDefaultTypes(),s.dataset){let t=s.dataset,i={book:t.book??"Unknown Book",quizDBname:t.databaseName??`${t.book??"Dataset"} Dataset`,quizIDPre:t.quizIdPrefix??"Quiz",quizIDNum:t.quizIdNumber??"1",backupDrive:t.backupDrive??"A",bookVersion:t.version??"",datasetId:t.id};yield this.dbService.saveUserFile(i),t.id&&(this.activeDatasetId=t.id,this.persistActiveDatasetId(t.id))}this.dataLoaded=!0}catch(t){throw console.error("\u274C Error loading data from provided object:",t),t}})}getPersistedDatasetId(){if(typeof window>"u")return null;try{return window.localStorage.getItem(this.datasetStorageKey)}catch(e){return console.warn("Unable to read persisted dataset id:",e),null}}persistActiveDatasetId(e){if(!(typeof window>"u"))try{window.localStorage.setItem(this.datasetStorageKey,e)}catch(s){console.warn("Unable to persist active dataset id:",s)}}clearQuestionData(){return c(this,null,function*(){yield this.dbService.init();let e=["questionDetail","questionSelect","quizSet","verses","types","parms"];return new Promise((s,o)=>{try{let t=this.dbService.db.transaction(e,"readwrite"),i=0,a=e.length;e.forEach(r=>{let n=t.objectStore(r).clear();n.onsuccess=()=>{i++,console.log(`  \u2713 Cleared ${r} (${i}/${a})`)},n.onerror=()=>{console.error(`  \u2717 Error clearing ${r}:`,n.error)}}),t.oncomplete=()=>{console.log("\u2705 Question data cleared, players/teams preserved"),s()},t.onerror=()=>{console.error("Transaction error in clearQuestionData:",t.error),o(t.error)}}catch(t){console.error("Exception in clearQuestionData:",t),o(t)}})})}processData(o){return c(this,arguments,function*(e,s={}){if(!e||typeof e!="object")throw new Error("Invalid data payload for direct load");let t=e.questions||e.QuestionDetail;if(t&&Array.isArray(t)&&t.length>0&&(console.log(`\u{1F4E5} Loading ${t.length} questions directly...`),yield this.loadQuestionsDirect(t)),s.questionsOnly)console.log("\u23ED\uFE0F  Skipping players (questions-only mode)");else{let d=e.players||e.Players;d&&Array.isArray(d)&&d.length>0&&(console.log(`\u{1F4E5} Loading ${d.length} players directly...`),yield this.loadPlayersDirect(d))}let i=e.questionSelect||e.QuestionSelect;i&&Array.isArray(i)&&i.length>0&&(console.log(`\u{1F4E5} Loading ${i.length} question select records directly...`),yield this.loadQuestionSelectDirect(i));let a=e.verses||e.Verses;if(a&&Array.isArray(a)&&a.length>0&&(console.log(`\u{1F4E5} Loading ${a.length} verses directly...`),yield this.loadVersesDirect(a)),s.questionsOnly)console.log("\u23ED\uFE0F  Skipping teams (questions-only mode)");else{let d=e.teams||e.Teams;d&&Array.isArray(d)&&d.length>0&&(console.log(`\u{1F4E5} Loading ${d.length} teams directly...`),yield this.loadTeamsDirect(d))}let r=e.types||e.Types;r&&Array.isArray(r)&&r.length>0&&(console.log(`\u{1F4E5} Loading ${r.length} question types directly...`),yield this.loadTypesDirect(r));let l=e.quizSets||e.QuizSet;l&&Array.isArray(l)&&l.length>0&&(console.log(`\u{1F4E5} Loading ${l.length} quiz sets directly...`),yield this.loadQuizSetsDirect(l));let n=e.userFile||e.UserFile;n&&(console.log("\u{1F4E5} Loading user file directly..."),yield this.dbService.saveUserFile(n));let u=e.parms||e.Parms;if(u){console.log("\u{1F4E5} Loading parameters directly...");let d=Array.isArray(u)?u:[u];for(let v of d){let P=D(b({},v),{book:v.book||v.Book});yield this.dbService.saveParms(P)}}let m=yield this.dbService.getAllQuestions(),f=yield this.dbService.getAllPlayers();console.log(`\u2705 Verification: ${m.length} questions, ${f.length} players in database`),m.length>0&&console.log("   \u{1F50D} Sample question:",m[0])})}loadQuestionsDirect(e){return c(this,null,function*(){let s=e.map(a=>{let r=parseInt(a.questionID||a.QuestionID||0,10),l=parseInt(a.qChapter||a.QChapter||0,10),n=parseInt(a.qBegVerse||a.QBegVerse||0,10),u=parseInt(a.qEndVerse||a.QEndVerse||0,10);return!r||isNaN(r)?null:{questionID:r,qdescription:(a.qdescription||a.QDescription||"").trim()||" ",qAnswer:(a.qAnswer||a.QAnswer||"").trim()||" ",qChapter:isNaN(l)?0:l,qBegVerse:isNaN(n)?0:n,qEndVerse:isNaN(u)?0:u,qDescType:(a.qDescType||a.QDescType||"").trim()||" ",book:this.currentBook,version:this.currentVersion}}).filter(a=>!!a&&a.questionID>0);if(console.log(`   Filtered to ${s.length} valid questions`),s.length===0){console.warn("   No valid questions to load");return}let o=0,t=0;for(let a of s)try{yield this.dbService.addQuestion(a),o++,o%100===0&&console.log(`   Saved ${o}/${s.length} questions...`)}catch(r){t++,console.error(`   Error saving question ${a.questionID}:`,r)}console.log(`   \u2705 Saved ${o} questions, ${t} failed`);let i=yield this.dbService.getAllQuestions();console.log(`   \u2705 Verification: ${i.length} questions now in database`),i.length>0&&console.log("   \u{1F50D} Sample question:",i[0])})}loadPlayersDirect(e){return c(this,null,function*(){let s=e.map(o=>{let t=parseInt(o.playerNumber||o["Player Number"]||0,10);return!t||isNaN(t)?null:{playerNumber:t,name:(o.name||o.Name||"").trim(),nickname:(o.nickname||o.Nickname||"").trim(),ageGroup:(o.ageGroup||o["Age Group"]||"").trim(),team:(o.team||o.Team||" ").trim()}}).filter(o=>!!o&&o.playerNumber>0);s.length>0&&(yield this.dbService.batchAddPlayers(s),console.log(`   \u2705 Saved ${s.length} players`))})}loadQuestionSelectDirect(e){return c(this,null,function*(){let s=0,o=0;for(let t of e){let i=parseInt(t.selectionID||t.SelectionID||0,10);if(!i||isNaN(i)){o++;continue}let a={selectionID:i,selectType:(t.selectType||t.SelectType||"").trim(),selChapter:parseInt(t.selChapter||t.SelChapter||0,10)||0,selVerse:parseInt(t.selVerse||t.SelVerse||0,10)||0,primUseCnt:parseInt(t.primUseCnt||t.PrimUseCnt||0,10)||0,bonUseCnt:parseInt(t.bonUseCnt||t.BonUseCnt||0,10)||0};try{yield this.dbService.addQuestionSelect(a),s++}catch(r){console.warn(`   \u26A0\uFE0F Unable to save question select for ${i}:`,r)}}console.log(`   \u2705 Saved ${s} question select records, skipped ${o}`)})}loadVersesDirect(e){return c(this,null,function*(){let s=e.map(o=>{let t=parseInt(o.chapter||o.Chapter||0,10),i=parseInt(o.verse||o.Verse||0,10);return!t||!i||isNaN(t)||isNaN(i)?null:{chapter:t,verse:i,text:(o.text||o.Text||"").trim()}}).filter(o=>!!o&&o.chapter>0&&o.verse>0);s.length>0&&(yield this.dbService.batchAddVerses(s),console.log(`   \u2705 Saved ${s.length} verses`))})}loadTeamsDirect(e){return c(this,null,function*(){let s=new Map;for(let o of e){let t=(o.teamName||o.TeamName||o["Team Name"]||o.team||"").trim();if(!t)continue;let i=s.get(t)??new Set;if(Array.isArray(o.playerNumbers))for(let l of o.playerNumbers){let n=Number(l);!Number.isNaN(n)&&n>0&&i.add(n)}let a=o.playerNumber||o.PlayerNumber||o["Player Number"],r=Number(a);!Number.isNaN(r)&&r>0&&i.add(r),s.set(t,i)}for(let[o,t]of s.entries())for(let i of t)try{yield this.dbService.addTeamMember(o,i)}catch{}console.log(`   \u2705 Processed ${s.size} teams`)})}loadTypesDirect(e){return c(this,null,function*(){for(let s of e)try{let o=(s.typeID||s.TypeID||s["Type ID"]||"").trim(),t=(s.leadIn||s.LeadIn||"").trim(),i=(s.Name||s.name||"").trim(),a=(s.class||s.Class||"").trim(),r=t;(!r||r==="B")&&i&&(a&&a!=="B"&&a!=="Q"?r=`a ${i} ${a} question`:r=`a ${i} question`);let l={typeID:o,class:a==="B"||a==="Q"?a:"B",leadIn:r};l.typeID&&(yield this.dbService.addType(l))}catch{}console.log(`   \u2705 Processed ${e.length} types`)})}loadQuizSetsDirect(e){return c(this,null,function*(){let s=e.map(o=>{let t=(o.setID||o.SetID||"").trim(),i=parseInt(o.questNum||o.QuestNum||0),a=parseInt(o.bonusNum||o.BonusNum||0);return t&&i>0?{setID:t,questNum:i,bonusNum:a}:null}).filter(o=>o!==null);s.length>0&&(yield this.dbService.batchAddQuizSets(s),console.log(`   \u2705 Saved ${s.length} quiz sets`))})}loadAllDatasets(e){return c(this,null,function*(){try{console.log("\u{1F310} Starting bulk import of ALL datasets..."),yield this.dbService.clearAllData(),yield this.dbService.init(),yield this.dbService.initializeDefaultTypes();let s=yield this.datasetCatalog.getCatalog(),o=s.length;console.log(`\u{1F4DA} Found ${o} datasets to import`);let t=0;for(let n of s){t++;let u=`[${t}/${o}] ${n.book} - ${n.version}`;console.log(`
\u{1F504} ${u}`),e&&e(u,t,o);try{let m=yield fetch(n.path);if(!m.ok){console.warn(`\u26A0\uFE0F Failed to load ${n.id}: ${m.statusText}`);continue}let f=yield m.json();this.currentBook=n.book,this.currentVersion=n.version,yield this.processData(f,{questionsOnly:!1}),console.log(`\u2705 Imported ${n.book} - ${n.version}`)}catch(m){console.error(`\u274C Error importing ${n.id}:`,m)}}let i={book:"All Books",quizDBname:"Complete Database",quizIDPre:"Quiz",quizIDNum:"1",backupDrive:"A",bookVersion:"Multiple Versions",datasetId:"bulk-import"};yield this.dbService.saveUserFile(i);let a=yield this.dbService.getAllPlayers(),r=yield this.dbService.getAllQuestions(),l=yield this.dbService.getAllTeams();console.log(`
\u2728 BULK IMPORT COMPLETE \u2728`),console.log("\u{1F4CA} Total imported:"),console.log(`   \u2022 ${r.length} questions`),console.log(`   \u2022 ${a.length} players`),console.log(`   \u2022 ${l.length} teams`),console.log(`   \u2022 ${o} datasets merged`),this.activeDatasetId="bulk-import",this.persistActiveDatasetId("bulk-import"),this.dataLoaded=!0,e&&e("Import complete!",o,o)}catch(s){throw console.error("\u274C Bulk import failed:",s),s}})}static \u0275fac=function(s){return new(s||p)(g(q),g(y),g(N))};static \u0275prov=h({token:p,factory:p.\u0275fac,providedIn:"root"})};export{y as a,w as b};
